<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>P2P So'z O'yini (PeerJS)</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f8fafc; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .container { background:#fff; width:90%; max-width:480px; padding:18px; border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.08); text-align:center; }
    input, button { width:100%; padding:12px; margin:8px 0; border-radius:10px; box-sizing:border-box; font-size:16px; }
    input { border:2px solid #e2e8f0; }
    button { border:0; background:#2563eb; color:#fff; font-weight:700; cursor:pointer; }
    .hidden { display:none !important; }
    .code { font-size:28px; letter-spacing:6px; font-weight:800; background:#f1f5f9; padding:10px; border-radius:12px; }
    .big-letter { font-size:64px; font-weight:900; color:#2563eb; margin:6px 0; }
    .status { font-size:12px; color:#475569; background:#f1f5f9; padding:6px 10px; border-radius:8px; }
    .row { display:flex; gap:8px; justify-content:center; }
    .score { width:90px; text-align:center; padding:10px; border:2px solid #e2e8f0; border-radius:10px; }
    .results-row { display:flex; border-bottom:1px solid #e2e8f0; padding:8px 0; text-align:left; }
    .results-row div { flex:1; }
  </style>
</head>
<body>
<div class="container">
  <!-- START -->
  <div id="view-start">
    <h2>‚ö° P2P So'z O'yini</h2>
    <p style="color:#64748b;margin-top:-6px;">Server yo'q. Host kod beradi, guest ulanadi.</p>

    <button id="btnCreate">üÜï Yangi xona</button>

    <div style="margin:10px 0; border-top:1px solid #eee;"></div>

    <input id="joinCode" placeholder="Xona kodi" style="text-transform:uppercase" />
    <input id="joinName" placeholder="Ismingiz" />
    <button id="btnJoin" style="background:#10b981;">Ulanish (Join)</button>

    <div class="status" id="startStatus">Tayyor.</div>
  </div>

  <!-- HOST LOBBY -->
  <div id="view-host" class="hidden">
    <h3>Xona yaratildi ‚úÖ</h3>
    <div class="code" id="hostCode">----</div>
    <div class="status" id="hostStatus">Raqib kutilmoqda...</div>
    <input id="hostName" placeholder="Sizning ismingiz" />
    <button id="btnStartGame" disabled>O'yinni boshlash</button>
  </div>

  <!-- GUEST LOBBY -->
  <div id="view-guest" class="hidden">
    <h3>Ulanmoqda...</h3>
    <div class="status" id="guestStatus">Host topilmoqda...</div>
  </div>

  <!-- GAME -->
  <div id="view-game" class="hidden">
    <div>Harf:</div>
    <div class="big-letter" id="letter">A</div>

    <input data-k="city" placeholder="Shahar" />
    <input data-k="name" placeholder="Ism" />
    <input data-k="food" placeholder="Ovqat" />
    <input data-k="movie" placeholder="Kino" />

    <button id="btnReady">‚úÖ Tayyor</button>
    <div class="status" id="gameStatus">So'zlar harf bilan boshlansin.</div>
  </div>

  <!-- RESULTS -->
  <div id="view-results" class="hidden">
    <h3>Natijalar</h3>
    <div id="board"></div>

    <div style="margin-top:14px; border-top:2px dashed #e2e8f0; padding-top:10px;">
      <div style="margin-bottom:6px;">Ballarni qo'lda kiriting:</div>
      <div class="row">
        <input class="score" id="s1" type="number" min="0" max="4" placeholder="P1" />
        <input class="score" id="s2" type="number" min="0" max="4" placeholder="P2" />
      </div>
      <button id="btnTotal" style="background:#6366f1;">Jami hisob</button>
      <div id="total" style="font-weight:800;margin-top:8px;"></div>
    </div>

    <button onclick="location.reload()" style="background:#94a3b8;margin-top:12px;">Yangi o'yin</button>
  </div>
</div>

<script>
(() => {
  const PREFIX = "uzgame-v2-";

  let peer = null;
  let conn = null;

  let role = null; // host/guest
  let myName = "";
  let oppName = "Raqib";
  let letter = "A";

  let myDraft = { city:"", name:"", food:"", movie:"" };
  let oppDraft = { city:"", name:"", food:"", movie:"" };

  const $ = (id) => document.getElementById(id);
  const show = (id) => {
    ["view-start","view-host","view-guest","view-game","view-results"].forEach(v => $(v).classList.add("hidden"));
    $(id).classList.remove("hidden");
  };

  function setStatus(id, msg){ $(id).textContent = msg; }

  function createPeer(idOrNull){
    // STUN qo'shildi (ko'p hollarda ulanishni yaxshilaydi)
    return new Peer(idOrNull ?? undefined, {
      debug: 2,
      config: {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" }
        ]
      }
    });
  }

  function genCode(){
    return Math.random().toString(36).substring(2,6).toUpperCase();
  }

  function startGameplay(){
    show("view-game");
    $("letter").textContent = letter;

    // input sync
    document.querySelectorAll('#view-game input[data-k]').forEach(inp => {
      inp.value = myDraft[inp.dataset.k] || "";
      inp.oninput = () => {
        myDraft[inp.dataset.k] = inp.value;
        if (conn?.open) conn.send({ t:"DRAFT", k: inp.dataset.k, v: inp.value });
      };
    });

    setStatus("gameStatus", `Hamma so'z "${letter}" bilan boshlansin.`);
  }

  function validateAll(){
    let ok = true;
    document.querySelectorAll('#view-game input[data-k]').forEach(inp => {
      const v = (inp.value || "").trim();
      if (!v.toUpperCase().startsWith(letter)) { ok = false; inp.style.borderColor = "#ef4444"; }
      else inp.style.borderColor = "#22c55e";
    });
    return ok;
  }

  function renderResults(p1Name, p1, p2Name, p2){
    show("view-results");
    const fields = [
      ["city","üèô Shahar"],
      ["name","üë§ Ism"],
      ["food","üçΩ Ovqat"],
      ["movie","üé¨ Kino"],
    ];
    let html = `<div class="results-row" style="font-weight:800;">
      <div>Kategoriya</div><div>${p1Name}</div><div>${p2Name}</div>
    </div>`;
    for (const [k,label] of fields){
      html += `<div class="results-row">
        <div>${label}</div><div>${(p1[k]||"-")}</div><div>${(p2[k]||"-")}</div>
      </div>`;
    }
    $("board").innerHTML = html;
  }

  function wireConn(){
    conn.on("open", () => {
      if (role === "guest") setStatus("guestStatus", "Ulandi ‚úÖ Host start bosishini kuting...");
    });

    conn.on("data", (m) => {
      if (!m || !m.t) return;

      if (m.t === "JOIN" && role === "host") {
        oppName = m.name || "Guest";
        setStatus("hostStatus", `‚úÖ ${oppName} ulandi!`);
        $("btnStartGame").disabled = false;
      }

      if (m.t === "START") {
        letter = m.letter;
        oppName = m.hostName || oppName;
        startGameplay();
      }

      if (m.t === "DRAFT") {
        oppDraft[m.k] = m.v;
      }

      // Kimdir READY bosdi => o'yin tugaydi, natija ko'rsatiladi
      if (m.t === "READY") {
        const finisher = m.name || "Raqib";
        // Qabul qiluvchi ham darhol natijaga o'tadi
        if (role === "host") {
          // host natijani ikkala tomonga yuboradi
          renderResults(myName, myDraft, finisher, m.answers);

          conn.send({ t:"GAME_OVER", hostName: myName, hostAnswers: myDraft, guestName: finisher, guestAnswers: m.answers });
        } else {
          // guest hostdan READY kelsa ham natijani ko'rsatadi (host keyin GAME_OVER yuboradi)
          renderResults(finisher, m.answers, myName, myDraft);
        }
      }

      if (m.t === "GAME_OVER" && role === "guest") {
        renderResults(m.hostName, m.hostAnswers, m.guestName, m.guestAnswers);
      }
    });

    conn.on("error", (e) => alert("Connection error: " + e));
    conn.on("close", () => alert("Aloqa uzildi. Qayta urinib ko'ring."));
  }

  // UI events
  $("btnCreate").onclick = () => {
    role = "host";
    show("view-host");

    const code = genCode();
    $("hostCode").textContent = code;
    setStatus("hostStatus", "Peer serverga ulanmoqda...");

    peer = createPeer(PREFIX + code);

    peer.on("open", () => setStatus("hostStatus", "Xona tayyor. Raqib kutilmoqda..."));
    peer.on("connection", (c) => {
      conn = c;
      wireConn();
    });
    peer.on("error", (e) => {
      alert("Peer error: " + e.type + "\nQayta Create qilib ko'ring.");
      location.reload();
    });
  };

  $("btnJoin").onclick = () => {
    role = "guest";

    const code = ($("joinCode").value || "").trim().toUpperCase();
    myName = ($("joinName").value || "").trim();
    if (!code || !myName) { alert("Kod va ism kiriting!"); return; }

    show("view-guest");
    setStatus("guestStatus", "Peer tayyorlanmoqda...");

    peer = createPeer(null);

    peer.on("open", () => {
      setStatus("guestStatus", "Hostga ulanmoqda...");
      conn = peer.connect(PREFIX + code, { reliable: true });

      conn.on("open", () => {
        wireConn();
        conn.send({ t:"JOIN", name: myName });
      });

      conn.on("error", () => {
        alert("Xona topilmadi yoki ulanish bloklangan. Kodni tekshiring.");
        location.reload();
      });
    });

    peer.on("error", (e) => {
      alert("Peer error: " + e.type);
      location.reload();
    });
  };

  $("btnStartGame").onclick = () => {
    myName = ($("hostName").value || "").trim();
    if (!myName) { alert("Ismingizni kiriting!"); return; }
    if (!conn || !conn.open) { alert("Raqib ulanmagan."); return; }

    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    letter = alphabet[Math.floor(Math.random() * alphabet.length)];

    conn.send({ t:"START", letter, hostName: myName });
    startGameplay();
  };

  $("btnReady").onclick = () => {
    if (!conn || !conn.open) { alert("Ulanish yo'q."); return; }
    if (!myName) myName = role === "host" ? ($("hostName").value || "Host") : myName;

    if (!validateAll()) { setStatus("gameStatus", "Xato! Hammasi harf bilan boshlansin."); return; }

    conn.send({ t:"READY", name: myName, answers: { ...myDraft } });

    // host bo'lsa ham darhol natijaga o'tmaymiz ‚Äî host natijani handle qiladi (READY kelganda)
    // guest bo'lsa: natija hostdan keladi
    setStatus("gameStatus", "Yuborildi. Natija kutilyapti...");
  };

  $("btnTotal").onclick = () => {
    const a = Number($("s1").value || 0);
    const b = Number($("s2").value || 0);
    $("total").textContent = `Jami: ${a} : ${b}`;
  };

  // initial
  show("view-start");
})();
</script>
</body>
</html>
